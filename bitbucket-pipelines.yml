export: true

options:
  max-time: 30
  docker: false

definitions:
  runners:
    - self-hosted: &selfhosted-runner
        runs-on:
          - 'self.hosted'
          - 'linux.shell'

  changesets:
    - includePaths: &code-backstage-changesets
      - ".gitattributes"
      - ".golangci.yaml"
      - ".goreleaser.yml"
      - "buf.gen.yaml"
      - "bitbucket-pipelines.yml"
      - "Makefile*"
      - "{ci,dockerfiles,packaging,scripts,tests}/**/*"
      - "**/*.go"
      - "go.*"

    - includePaths: &docs-changesets
      - ".vale.ini"
      - ".markdownlint.yml"
      - "docs/**/*"
      - "scripts/lint-docs"

  conditions:
    - condition: &code-backstage-condition
        changesets:
          includePaths: *code-backstage-changesets

  steps:
    - step: &prepare-version-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Extract version
        script:
          - echo "WEBITEL_VERSION=$(date +v%y.%-m)-dev.$BITBUCKET_BUILD_NUMBER" >> $BITBUCKET_PIPELINES_VARIABLES_PATH
          - echo "WEBITEL_DEB_COMPONENT=dev" >> $BITBUCKET_PIPELINES_VARIABLES_PATH
        output-variables: [ WEBITEL_VERSION, WEBITEL_DEB_COMPONENT ]

    - step: &prepare-dependencies-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Generate code
        script:
          - go mod download
          - go generate ./...
        artifacts:
          paths:
            - gen/go/**
            - cmd/wire_gen.go

    - step: &test-compile-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Compile application
        on-fail: { strategy: fail }
        script:
          - GORELEASER_CURRENT_TAG=$WEBITEL_VERSION goreleaser release --clean --skip publish --skip validate
        artifacts:
          download: true
          paths:
            - dist/webitel-wfm-*.*

    - step: &test-linting-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Lint code
        on-fail: { strategy: ignore }
        variables:
          GOLANGCI_LINT_CACHE: ~/.cache/golangci-lint
        script:
          - golangci-lint run # TODO: upload reports to Bitbucket; --out-format=checkstyle > checkstyle-result.xml

    - step: &test-unit-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Unit testing
        on-fail: { strategy: ignore }
        script:
          - mkdir -p test-reports
          - go test -short -v 2>&1 ./... | go run github.com/jstemmer/go-junit-report/v2@v2.1.0 -set-exit-code > test-reports/junit.xml

    - step: &test-gitleaks-step
        <<: *selfhosted-runner
        name: Secret scanner
        on-fail: { strategy: fail }
        script:
          - mkdir -p test-reports
          - gitleaks git --report-format junit --report-path "test-reports/gitleaks.xml" # TODO: upload reports to Bitbucket

    - step: &deploy-development-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Deploy (development)
        deployment: development
        script:
          - > 
            helper deploy --user $DEPLOYMENTS_USER \
              --host $DEV_HOST \
              --key ~/.ssh/$DEPLOYMENTS_USER \
              --package "webitel-wfm-*.deb" \
              --source-dir "$BITBUCKET_CLONE_DIR/dist" \
              --remote-dir "/home/$DEPLOYMENTS_USER/dist/"

    - step: &deploy-testing-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Deploy (testing)
        trigger: manual
        deployment: testing
        script:
          - >
            helper deploy --user $DEPLOYMENTS_USER \
              --host $TEST_HOST \
              --key ~/.ssh/$DEPLOYMENTS_USER \
              --package "webitel-wfm-*.deb" \
              --source-dir "$BITBUCKET_CLONE_DIR/dist" \
              --remote-dir "/home/$DEPLOYMENTS_USER/dist/"

    - step: &deploy-staging-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Deploy (staging)
        trigger: manual
        deployment: staging
        script:
          - >
            scp -i ~/.ssh/$DEPLOYMENTS_USER -o StrictHostKeychecking=no \
              -rp dist/webitel-wfm-*.deb $DEPLOYMENTS_USER@$STAGE_HOST:~/dist/
          - >
            ssh -i ~/.ssh/$DEPLOYMENTS_USER -o StrictHostKeychecking=no \
              $DEPLOYMENTS_USER@$STAGE_HOST "sudo dpkg -i dist/webitel-wfm-*.deb && rm -f dist/webitel-wfm-*.deb"

    - step: &publish-deb-step
        <<: *selfhosted-runner
        <<: *code-backstage-condition
        name: Publish .deb package
        trigger: manual
        deployment: acceptance
        script:
          - >
            deb-s3 upload "dist/webitel-wfm-*.deb" --visibility nil --arch amd64 \
              --component "$WEBITEL_DEB_COMPONENT" \
              --codename "$DEB_CODENAME" \
              --access-key-id "$DEB_AWS_ACCESS_KEY_ID" \
              --secret-access-key "$DEB_AWS_SECRET_ACCESS_KEY" \
              --s3-region "$DEB_AWS_DEFAULT_REGION" \
              --bucket "$DEB_AWS_BUCKET_NAME"

    - parallel: &test-parallel
        steps:
          - step: *test-compile-step
          - step: *test-linting-step
          - step: *test-unit-step
          - step: *test-gitleaks-step

pipelines:
  default:
    - stage:
        <<: *code-backstage-condition
        name: Prepare
        steps:
          - step: *prepare-version-step
          - step: *prepare-dependencies-step

    - parallel: *test-parallel

  branches:
    # Code from development branch deploys to development
    # and testing environments with manual approves.
    main:
      - stage:
          <<: *code-backstage-condition
          name: Prepare
          steps:
            - step: *prepare-version-step
            - step: *prepare-dependencies-step

      - parallel: *test-parallel
      - step: *deploy-development-step
      - step: *deploy-testing-step
      - step: *publish-deb-step

    # Release branches goes to staging environments.
    v*.*:
      - stage:
          <<: *code-backstage-condition
          name: Prepare
          steps:
            - step:
                <<: *prepare-version-step
                script:
                  - echo "WEBITEL_VERSION=$BITBUCKET_BRANCH-$BITBUCKET_BUILD_NUMBER" >> $BITBUCKET_PIPELINES_VARIABLES_PATH
                  - echo "WEBITEL_DEB_COMPONENT=$BITBUCKET_BRANCH-releases" >> $BITBUCKET_PIPELINES_VARIABLES_PATH

            - step: *prepare-dependencies-step

      - parallel: *test-parallel
      - step: *deploy-staging-step
      - parallel:
          steps:
            - step:
                <<: *publish-deb-step
                deployment: releases
